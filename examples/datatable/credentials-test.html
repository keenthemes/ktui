<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>DataTable Request Credentials Test</title>
	<link rel="stylesheet" href="../../dist/styles.css">
</head>

<body class="bg-gray-50 min-h-screen p-4">
	<div class="container mx-auto max-w-6xl">
		<!-- Header -->
		<div class="bg-white rounded-lg shadow-lg p-8 mt-6 border border-gray-200">
			<h1 class="text-2xl font-bold text-gray-900 mb-2">DataTable Request Credentials Test</h1>
			<p class="text-sm text-gray-600 mb-4">
				Test the <code class="bg-gray-100 px-1 rounded">requestCredentials</code> option for controlling cookie and credential inclusion in fetch requests.
			</p>

			<!-- Instructions -->
			<div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-4">
				<h2 class="text-sm font-semibold text-gray-900 mb-2">Testing Instructions</h2>
				<ol class="text-sm text-gray-700 list-decimal list-inside space-y-1.5">
					<li>Open Browser DevTools (F12) → Network tab</li>
					<li>Select a credential mode above and click "Reload"</li>
					<li>Inspect the request → Headers → Request Headers</li>
					<li>Check the <code class="bg-white px-1.5 py-0.5 rounded border border-gray-300 text-xs font-mono">Cookie</code> header to verify credentials</li>
					<li>For cross-origin: Check <code class="bg-white px-1.5 py-0.5 rounded border border-gray-300 text-xs font-mono">Access-Control-Allow-Credentials</code> in Response Headers</li>
				</ol>
			</div>

			<!-- Credential Mode Selector -->
			<div class="mb-6">
				<label class="block text-sm font-medium text-gray-700 mb-3">
					Credential Mode:
				</label>
				<div class="flex gap-2 flex-wrap items-center">
					<button
						onclick="changeCredentialsMode('omit')"
						data-mode="omit"
						class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 text-sm font-medium">
						Omit
					</button>
					<button
						onclick="changeCredentialsMode('same-origin')"
						data-mode="same-origin"
						class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 text-sm font-medium">
						Same-Origin
					</button>
					<button
						onclick="changeCredentialsMode('include')"
						data-mode="include"
						class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 text-sm font-medium">
						Include
					</button>
					<span class="text-gray-400 mx-2">|</span>
					<button
						onclick="reloadDataTable()"
						class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 text-sm font-medium">
						Reload
					</button>
				</div>
				<div class="mt-3 flex items-center gap-2">
					<span class="text-sm text-gray-500">Active:</span>
					<code id="currentMode" class="bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-800 border border-gray-200">same-origin</code>
				</div>
			</div>

			<!-- Current Configuration Display -->
			<div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-4">
				<h3 class="text-sm font-semibold text-gray-800 mb-2">Current Configuration:</h3>
				<pre id="configDisplay" class="text-xs bg-white p-3 rounded border border-gray-300 overflow-x-auto"><code>{
  "apiEndpoint": "https://jsonplaceholder.typicode.com/users",
  "requestMethod": "GET",
  "requestCredentials": "same-origin"
}</code></pre>
			</div>
		</div>

		<!-- DataTable Container -->
		<div class="bg-white rounded-lg shadow-lg p-8 mt-6 border border-gray-200">
			<div class="kt-card">
				<div class="kt-card-table" id="credentials-datatable-container">
					<div class="kt-table-wrapper kt-scrollable">
						<table id="credentials-table" class="kt-table" data-kt-datatable-table="true">
							<thead>
								<tr>
									<th scope="col" class="w-20" data-kt-datatable-column="id">
										<span class="kt-table-col">
											<span class="kt-table-col-label">ID</span>
											<span class="kt-table-col-sort"></span>
										</span>
									</th>
									<th scope="col" class="w-48" data-kt-datatable-column="name">
										<span class="kt-table-col">
											<span class="kt-table-col-label">Name</span>
											<span class="kt-table-col-sort"></span>
										</span>
									</th>
									<th scope="col" class="w-64" data-kt-datatable-column="email">
										<span class="kt-table-col">
											<span class="kt-table-col-label">Email</span>
											<span class="kt-table-col-sort"></span>
										</span>
									</th>
									<th scope="col" class="w-48" data-kt-datatable-column="username">
										<span class="kt-table-col">
											<span class="kt-table-col-label">Username</span>
											<span class="kt-table-col-sort"></span>
										</span>
									</th>
									<th scope="col" class="w-64" data-kt-datatable-column="phone">
										<span class="kt-table-col">
											<span class="kt-table-col-label">Phone</span>
											<span class="kt-table-col-sort"></span>
										</span>
									</th>
								</tr>
							</thead>
							<tbody>
								<!-- Data will be loaded from API -->
							</tbody>
						</table>
					</div>

					<!-- Pagination Info -->
					<div class="flex items-center justify-between mt-4">
						<div class="flex items-center space-x-2">
							<span class="text-sm text-gray-700">Show</span>
							<select data-kt-datatable-size="true" class="border border-gray-300 rounded px-2 py-1 bg-white text-gray-900">
								<option value="5" selected>5</option>
								<option value="10">10</option>
								<option value="20">20</option>
							</select>
							<span class="text-sm text-gray-700">entries</span>
						</div>
						<div data-kt-datatable-info="true" class="text-sm text-gray-700"></div>
					</div>

					<!-- Pagination Controls -->
					<div class="flex justify-center mt-4">
						<div data-kt-datatable-pagination="true" class="flex space-x-1"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Network Request Monitor -->
		<div class="bg-white rounded-lg shadow-lg p-8 mt-6 border border-gray-200">
			<div class="flex items-center justify-between mb-3">
				<h2 class="text-lg font-semibold text-gray-800">Network Request Monitor</h2>
				<button
					onclick="clearRequestLog()"
					class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 text-sm font-medium">
					Clear
				</button>
			</div>
			<div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-4">
				<p class="text-sm text-gray-600 mb-2">
					<strong>Note:</strong> This log shows fetch events. For detailed request headers including cookies, check Browser DevTools → Network tab.
				</p>
			</div>
			<div id="requestLog" class="bg-gray-50 border border-gray-200 rounded-md p-4 h-64 overflow-y-auto font-mono text-sm">
				<div class="text-gray-500">No requests yet. Reload the DataTable to see fetch events...</div>
			</div>
		</div>

		<!-- Testing Guide -->
		<div class="bg-white rounded-lg shadow-lg p-8 mt-6 border border-gray-200">
			<h2 class="text-lg font-semibold text-gray-800 mb-4">Testing Guide</h2>

			<div class="space-y-4">
				<div>
					<h3 class="text-sm font-semibold text-gray-700 mb-2">1. Testing with Browser DevTools</h3>
					<ol class="text-sm text-gray-600 list-decimal list-inside space-y-1 ml-2">
						<li>Open DevTools (F12 or Right-click → Inspect)</li>
						<li>Go to the <strong>Network</strong> tab</li>
						<li>Select a credential mode and reload the DataTable</li>
						<li>Click on the request to <code>jsonplaceholder.typicode.com</code></li>
						<li>Check the <strong>Headers</strong> tab:
							<ul class="list-disc list-inside ml-4 mt-1">
								<li><strong>Request Headers:</strong> Look for <code>Cookie</code> header (should appear with 'include' mode)</li>
								<li><strong>Response Headers:</strong> Check for <code>Access-Control-Allow-Credentials</code> (for cross-origin)</li>
							</ul>
						</li>
					</ol>
				</div>

				<div>
					<h3 class="text-sm font-semibold text-gray-700 mb-2">2. Credential Modes Explained</h3>
					<ul class="text-sm text-gray-600 space-y-2">
						<li>
							<strong class="text-gray-800">omit:</strong> Never sends cookies or credentials, even for same-origin requests.
							Useful for APIs that don't require authentication.
						</li>
						<li>
							<strong class="text-gray-800">same-origin:</strong> Sends credentials only when the API endpoint is on the same origin
							as the page. This is the browser default behavior.
						</li>
						<li>
							<strong class="text-gray-800">include:</strong> Always sends credentials, including cookies, for both same-origin and
							cross-origin requests. Requires proper CORS configuration on the server.
						</li>
					</ul>
				</div>

				<div>
					<h3 class="text-sm font-semibold text-gray-700 mb-2">3. Testing with Real Session Cookies</h3>
					<p class="text-sm text-gray-600 mb-2">
						To test with actual session cookies:
					</p>
					<ol class="text-sm text-gray-600 list-decimal list-inside space-y-1 ml-2">
						<li>Set up a local API server or use a test endpoint that accepts cookies</li>
						<li>Set a cookie via JavaScript: <code class="bg-gray-100 px-1 rounded">document.cookie = "session=test123; path=/"</code></li>
						<li>Change the <code class="bg-gray-100 px-1 rounded">apiEndpoint</code> to your test endpoint</li>
						<li>Select <code class="bg-gray-100 px-1 rounded">include</code> mode and reload</li>
						<li>Verify the cookie appears in the request headers in DevTools</li>
					</ol>
				</div>

				<div>
					<h3 class="text-sm font-semibold text-gray-700 mb-2">4. Expected Behavior</h3>
					<ul class="text-sm text-gray-600 space-y-1">
						<li>✓ <strong>omit:</strong> No <code>Cookie</code> header in request</li>
						<li>✓ <strong>same-origin:</strong> <code>Cookie</code> header only if API is same origin</li>
						<li>✓ <strong>include:</strong> <code>Cookie</code> header always present (if cookies exist)</li>
						<li>✓ Backward compatibility: Works without <code>requestCredentials</code> (uses browser default)</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<script src="../../dist/ktui.js"></script>
	<script>
		let datatableInstance = null;
		let currentCredentialsMode = 'same-origin';

		// Update configuration display
		function updateConfigDisplay() {
			const config = {
				apiEndpoint: 'https://jsonplaceholder.typicode.com/users',
				requestMethod: 'GET',
				requestCredentials: currentCredentialsMode
			};
			document.getElementById('configDisplay').textContent = JSON.stringify(config, null, 2);
			document.getElementById('currentMode').textContent = currentCredentialsMode;
		}

		// Change credentials mode
		function changeCredentialsMode(mode) {
			currentCredentialsMode = mode;
			updateConfigDisplay();

			// Update button active state - keep dark style but adjust opacity
			document.querySelectorAll('[data-mode]').forEach(btn => {
				if (btn.getAttribute('data-mode') === mode) {
					btn.classList.remove('opacity-75');
					btn.classList.add('opacity-100', 'ring-2', 'ring-gray-400');
				} else {
					btn.classList.remove('opacity-100', 'ring-2', 'ring-gray-400');
					btn.classList.add('opacity-75');
				}
			});

			addRequestLog('info', `Credential mode changed to: ${mode}`);
		}

		// Reload DataTable with current configuration
		function reloadDataTable() {
			if (datatableInstance && typeof datatableInstance.reload === 'function') {
				addRequestLog('fetch', 'Reloading DataTable...');
				datatableInstance.reload();
			} else {
				addRequestLog('error', 'DataTable instance not found');
			}
		}

		// Initialize DataTable
		function initDataTable() {
			const container = document.getElementById('credentials-datatable-container');
			if (!container) {
				console.error('Container not found');
				return;
			}

			// Force clean slate - remove all data attributes and instance
			container.removeAttribute('data-kt-datatable');
			if (container.instance) {
				delete container.instance;
			}
			datatableInstance = null;

			try {
				// Add cache-busting parameter to ensure fresh requests
				const cacheBuster = Date.now();

				datatableInstance = new KTDataTable(container, {
					apiEndpoint: `https://jsonplaceholder.typicode.com/users?_=${cacheBuster}`,
					requestMethod: 'GET',
					requestHeaders: {
						'Content-Type': 'application/json',
						'Accept': 'application/json',
						'Cache-Control': 'no-cache'
					},
					requestCredentials: currentCredentialsMode,
					stateSave: false, // Disable state saving to force fresh fetches
					pageSize: 5,
					columns: {
						id: {
							title: 'ID'
						},
						name: {
							title: 'Name'
						},
						email: {
							title: 'Email'
						},
						username: {
							title: 'Username'
						},
						phone: {
							title: 'Phone'
						}
					},
					mapResponse: function(response) {
						if (Array.isArray(response)) {
							return {
								data: response,
								totalCount: response.length
							};
						}
						return {
							data: response.data || [],
							totalCount: response.totalCount || 0
						};
					}
				});

				// Listen to fetch events
				container.addEventListener('kt.datatable.fetch', function() {
					addRequestLog('fetch', `Fetching data with credentials: ${currentCredentialsMode}`);
				});

				container.addEventListener('kt.datatable.fetched', function(event) {
					addRequestLog('fetched', 'Data fetched successfully');
				});

				container.addEventListener('kt.datatable.error', function(event) {
					addRequestLog('error', `Error: ${event.detail?.error?.message || 'Unknown error'}`);
				});

				addRequestLog('info', `DataTable initialized with credentials mode: ${currentCredentialsMode}`);
				updateConfigDisplay();
			} catch (error) {
				console.error('Error initializing DataTable:', error);
				addRequestLog('error', `Initialization error: ${error.message}`);
			}
		}

		// Request log helper
		function addRequestLog(type, message) {
			const logElement = document.getElementById('requestLog');
			const timestamp = new Date().toLocaleTimeString();
			const logEntry = document.createElement('div');
			logEntry.className = 'mb-2 pb-2 border-b border-gray-200';

			let typeColor = 'text-gray-700';
			let typeBg = 'bg-gray-50';
			if (type === 'fetch') {
				typeColor = 'text-gray-800';
				typeBg = 'bg-gray-100';
			} else if (type === 'fetched') {
				typeColor = 'text-gray-700';
				typeBg = 'bg-gray-50';
			} else if (type === 'error') {
				typeColor = 'text-red-700';
				typeBg = 'bg-red-50';
			} else if (type === 'info') {
				typeColor = 'text-gray-600';
				typeBg = 'bg-gray-50';
			}

			logEntry.innerHTML = `
				<div class="flex items-start gap-2">
					<span class="text-gray-400 text-xs font-mono">[${timestamp}]</span>
					<span class="font-medium ${typeColor} text-xs px-1.5 py-0.5 rounded ${typeBg}">${type.toUpperCase()}</span>
					<span class="text-gray-700 text-sm">${message}</span>
				</div>
			`;

			// Remove "No requests yet" message if it exists
			const firstChild = logElement.firstChild;
			if (firstChild && firstChild.textContent.includes('No requests yet')) {
				logElement.removeChild(firstChild);
			}

			logElement.insertBefore(logEntry, logElement.firstChild);

			// Keep only last 50 entries
			while (logElement.children.length > 50) {
				logElement.removeChild(logElement.lastChild);
			}
		}

		function clearRequestLog() {
			const logElement = document.getElementById('requestLog');
			logElement.innerHTML = '<div class="text-gray-500">No requests yet. Reload the DataTable to see fetch events...</div>';
		}

		// Initialize on page load
		document.addEventListener('DOMContentLoaded', function() {
			setTimeout(() => {
				initDataTable();
				// Set initial active button
				changeCredentialsMode('same-origin');
			}, 100);
		});
	</script>
</body>

</html>

